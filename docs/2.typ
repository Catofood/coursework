#import "lib/gost.typ": *
#import "lib/titlepage.typ": *

#show: doc => init(doc)


= Анализ предметной области
-
= Разработка требований к программе
== Требования к пользовательскому интерфейсу

Микросервис аналитики предоставляет REST API, взаимодействие с которым осуществляется через HTTP запросы. Пользователями API являются как администраторы для получения статистики, так и различные микросервисы экосистемы.

== Требования к эндпоинтам

API документация предоставляется через Swagger UI по адресу `http://localhost:5000/swagger/index.html` при запуске приложения в режиме отладки.

StatisticsController предоставляет методы с базовым URL `/api/statistics`. Контроллер содержит набор endpoint'ов для получения аналитических данных о использовании бота.

+ *Базовый URL*: все эндпоинты доступны по адресу `/api/statistics`

+ *Метод запроса*: все эндпоинты используют HTTP метод GET для получения данных

+ *Формат параметров*: параметры передаются через query string в формате ISO 8601 для дат (`DateTimeOffset`)

+ *Формат ответа*: все ответы возвращаются в формате JSON с соответствующими HTTP статус-кодами

+ *Валидация параметров*: система проводит валидацию входных параметров и возвращает HTTP 400 при некорректных значениях

+ *Обработка ошибок*: система обрабатывает различные сценарии ошибок:
  HTTP 200: успешное выполнение запроса с возвращением данных
  HTTP 400: некорректные параметры запроса (некорректный формат дат, дата начала позже даты окончания, параметр `top` вне диапазона 1-100, будущая дата)
  HTTP 404: запрошенные данные не найдены в системе
  HTTP 500: внутренняя ошибка сервера

+ *Кодирование*: все строковые параметры должны быть правильно закодированы в URL

+ *Временные интервалы*: параметры `from` и `to` позволяют фильтровать данные по периодам, оба параметра опциональны. Если `from` не указан, берется начало истории, если `to` не указан, берется текущий момент времени

+ *Пагинация результатов*: для эндпоинтов с топ-N результатами используется параметр `top` (от 1 до 100, по умолчанию 10)

Описание функциональности каждого конкретного эндпоинта представлено ниже с соответствующими примерами запросов и ответов.

\ 
== Требования к интеграции программы с Kafka 
Микросервис потребляет события из двух топиков: `suai.user-performed-request` (события о запросах пользователя) и `suai.user-updated-message` (события об обновлении информации пользователя).

*Сообщения Kafka*: оба типа сообщений наследуют от `BaseUserMessage` с полями `TelegramUserId` и `OccuredAt`. Сообщение `UserPerformedRequestMessage` содержит `RequestType` (Search, RoomSchedule, GroupSchedule, TeacherSchedule) и опциональное `GroupName`. Сообщение `UserUpdatedMessage` содержит `UpdateType` (Registered, SubscribedToGroup, SetDefaultSettings, SetCustomSettings) и опциональное `SubscriptionGroupName`.

== Требования к используемым ресурсам

*Вычислительные ресурсы*: процессор минимум 1 ядро, рекомендуется 2+ ядра для production; память минимум 512 МБ, рекомендуется 1-2 ГБ; диск зависит от объема данных, минимум 10 ГБ для development.

*Внешние зависимости*: PostgreSQL 15+ для хранения данных; Apache Kafka для потребления событий; .NET 9.0 runtime для выполнения приложения; Docker и Docker Compose для контейнеризации.

*Сетевые ресурсы*: порт 5000 для REST API; порт 5433 для подключения к PostgreSQL (в dev режиме); порт для подключения к Kafka (по умолчанию 9092).

\ 
== Сценарии использования

=== Получение количества зарегистрированных пользователей
Администратор отправляет GET запрос на `/api/statistics/registered-users-count` с опциональными параметрами `from` и `to` (в формате ISO 8601) для получения количества зарегистрировавшихся пользователей за указанный временной промежуток. Если параметры не указаны, возвращается общее количество всех зарегистрировавшихся пользователей. Возвращаемое значение — целое число, либо HTTP 400 при некорректном формате дат (дата начала позже даты окончания, будущая дата), либо HTTP 500 при внутренней ошибке сервера.

=== Получение уникальных пользователей, просмотревших расписание

Администратор запрашивает количество уникальных пользователей, которые обращались к любому типу расписания (аудиторий, групп или преподавателей) за указанный период. Параметры `from` и `to` опциональны и определяют границы временного интервала анализа. Система подсчитывает для каждого пользователя количество его уникальных запросов к любому типу расписания и возвращает общее количество таких пользователей. Возможные ответы: целое число уникальных пользователей (HTTP 200), ошибка валидации параметров (HTTP 400), ненайденные данные (HTTP 404) или внутренняя ошибка (HTTP 500).

\  
=== Получение уникальных пользователей по типу расписания

Администратор может получить детальную информацию о пользователях в разрезе типов расписания через три отдельных endpoint'а:

*Расписание аудиторий* (`/unique-room-schedule-viewers-count`) — количество пользователей, запрашивавших расписание занятости аудиторий.

*Расписание групп* (`/unique-group-schedule-viewers-count`) — количество пользователей, запрашивавших расписание учебных групп.

*Расписание преподавателей* (`/unique-teacher-schedule-viewers-count`) — количество пользователей, запрашивавших расписание занятости преподавателей.

Для каждого запроса параметры `from` и `to` опциональны. Ответ содержит целое число уникальных пользователей для каждого типа или HTTP 400 при некорректных датах.

\
=== Получение топ N групп по подписчикам

Администратор запрашивает список наиболее популярных учебных групп по количеству уникальных подписчиков на конкретную дату. Параметры запроса включают: `top` (количество групп в топе, значение от 1 до 100, по умолчанию 10) и опциональный `to` (дата, на которую подсчитывать подписчиков, если не указан — текущее состояние). Система для каждого пользователя определяет его последнюю подписку на группу, группирует результаты по названию группы, подсчитывает уникальных подписчиков, сортирует по убыванию количества подписчиков и возвращает топ-N результатов. Ответ — JSON массив объектов с полями `groupName` и `subscribersCount`, либо HTTP 400 если параметр `top` вне диапазона или указана будущая дата.

\
=== Получение топ N групп по просмотрам расписания

Администратор получает рейтинг учебных групп по количеству запросов их расписания за указанный период. Параметры: `top` (1-100, по умолчанию 10) определяет размер топа, `from` и `to` (опциональны) определяют временной интервал анализа. Система агрегирует все запросы расписания по группам, подсчитывает количество запросов для каждой группы, сортирует по убыванию и возвращает топ-N группы. Ответ — JSON массив объектов с названием группы и количеством запросов, либо HTTP 400 при некорректных параметрах (top вне диапазона, дата начала позже окончания, будущая дата).

\ 
=== Получение общего количества запросов расписания групп

Администратор запрашивает суммарное количество всех запросов на просмотр расписания групп за указанный период. Параметры `from` и `to` опциональны и определяют границы анализа. Если параметры не указаны, возвращается общее количество всех запросов расписания групп в системе. Ответ — целое число запросов, либо HTTP 400 при некорректных датах, либо HTTP 404 если данные не найдены.

\
=== Получение статистики по кастомным настройкам пользователей

Администратор может получить текущее состояние использования кастомных и дефолтных настроек пользователями на определенную дату:

*Пользователи с кастомными настройками* (`/users-with-custom-settings-count`) — количество пользователей, активно использующих персонализированные настройки системы на указанную дату.

*Пользователи с дефолтными настройками* (`/users-with-default-settings-count`) — количество пользователей, использующих стандартную конфигурацию настроек на указанную дату.

Параметр `to` опционален (если не указан, используется текущее время). Система определяет для каждого пользователя его последний тип настроек (кастомные или дефолтные) на дату `to` и подсчитывает количество. Ответ — целое число пользователей, либо HTTP 400 при указании будущей даты.

\
=== Получение количества пользователей, изменявших настройки

Администратор запрашивает количество уникальных пользователей, которые выполняли операции по изменению кастомных настроек за указанный период. Эндпоинт `/users-who-set-custom-settings-count` принимает опциональные параметры `from` и `to` для определения временного интервала. Система подсчитывает каждого пользователя только один раз, даже если он несколько раз менял настройки. Ответ — целое число уникальных пользователей, либо HTTP 400 при некорректных датах, либо HTTP 404 если данные не найдены.

=== Получение статистики по поисковым запросам

Администратор может получить детальную информацию о поисковой активности через два endpoint'а:

*Количество уникальных пользователей, выполнявших поиск* (`/unique-users-who-searched-count`) — определяет количество уникальных пользователей, которые использовали поисковую функциональность за указанный период.

*Общее количество поисковых запросов* (`/search-requests-count`) — подсчитывает суммарное количество всех поисковых операций, выполненных в системе.

Для обоих запросов параметры `from` и `to` опциональны. Ответ содержит целое число (пользователей или запросов в зависимости от endpoint'а), либо HTTP 400 при некорректных датах, либо HTTP 404 если данные отсутствуют.